# План работ VK Dating Telegram Bot (локальный запуск, 2 разработчика)

## Входные требования
1) Кнопка "Старт": при старте бот показывает сообщение "Введите токен vk".
2) Потом "Введите ваш VK ID".
3) Бот тестирует соединение (валидирует токен).
4) После успешной проверки доступна кнопка "Настроить фильтры поиска".
5) После нажатия бот задаёт 4 вопроса:
   1) Укажите город для поиска
   2) Укажите пол для поиска кандидатов
   3) Укажите интересующий начальный возраст кандидатов
   4) Укажите интересующий максимальный возраст кандидатов
6) Главный экран:
   - Предыдущий
   - Далее
   - Дополнительно → В избранное / В чёрный список / Показать избранное → Удалить из избранного / Настроить фильтры
7) Кнопки лайк отсутствуют.

---

## Участники
- **Участник A** — VK API + Telegram Bot + обработка фото (InsightFace) + сборка проекта
- **Участник B** — БД (PostgreSQL) + реализация `UserRepo` Protocol + интеграция bot↔db

---

## Текущий статус проекта

### Что сделано (Участник A):

#### Этап 1: Подготовка проекта
- [x] Создан репозиторий, каркас проекта (src/, data/, repo/)
- [x] Файлы конфигурации: `.env.example`, `requirements.txt`, `.gitignore`
- [x] FSM-стейты: `AuthState` (WAIT_VK_TOKEN, WAIT_VK_ID), `FilterState` (4 шага), `MenuState` (MAIN, MORE, FAVORITES)
- [x] Клавиатуры согласно архитектуре кнопок

#### Этап 2: VK API + Vision + бизнес-логика
- [x] VK client (aiohttp) + методы: users.get, users.search, photos.get, database.getCities
- [x] AuthService: проверка токена + сверка vk_id + сохранение
- [x] InsightFace модуль (vision/): detector, embedder, blur_check, photo_selector
- [x] PhotoProcessingService: скачивание + InsightFace пайплайн
- [x] Флаг `USE_INSIGHTFACE` в конфиге (true/false)
- [x] Оптимизации производительности:
  - InsightFace в thread pool executor (не блокирует event loop)
  - Параллельное скачивание фото (asyncio.gather)
  - Прогрев детектора при старте (warm-up)
  - Предзагрузка фото на 5 кандидатов вперёд

#### Этап 3: Telegram UI
- [x] /start → ввод токена → ввод vk_id → авторизация
- [x] Настройка фильтров (4 вопроса через FSM)
- [x] Главный экран: Предыдущий / Далее / Дополнительно
- [x] В избранное / В чёрный список / Показать избранное / Удалить из избранного
- [x] Сообщение "Ищу фото кандидата..." при загрузке
- [x] Просмотр анкеты из избранного (без повторной обработки фото)

#### Заглушка для БД
- [x] Protocol `UserRepo` — интерфейс с 18 методами
- [x] `InMemoryUserRepo` — реализация в памяти (MVP-заглушка)
- [x] DTO: `UserDTO`, `ProfileDTO`, `PhotoDTO`

---

## Задачи для Участника B (PostgreSQL + интеграция)

### Этап 2B: База данных

1) **Создать таблицы PostgreSQL** (6 таблиц):
   - `tg_users` — данные пользователя Telegram (токен VK, фильтры, курсор)
   - `vk_profiles` — профили кандидатов VK (имя, фамилия, domain)
   - `vk_photos` — метаданные фото (url, лайки, local_path, status)
   - `search_queue` — очередь кандидатов per user (с позицией)
   - `favorites` — избранное
   - `blacklist` — чёрный список

   SQL-схема приведена в `repo/README.md` раздел 8.

2) **Реализовать `PostgresUserRepo`** — drop-in замена `InMemoryUserRepo`:
   - Реализовать все 18 методов Protocol `UserRepo`
   - Описание каждого метода и SQL-логика — в `repo/README.md` раздел 8
   - Важные детали:
     - `add_blacklist` должен также удалять кандидата из очереди и корректировать курсор
     - `update_filters` должен сбрасывать очередь и курсор
     - `set_queue` должен сбрасывать курсор

3) **Подключить PostgresUserRepo** в `bot.py`:
   - Заменить `InMemoryUserRepo()` на `PostgresUserRepo(session)`
   - Добавить `DATABASE_URL` в конфиг
   - Создать async engine/sessionmaker (asyncpg или psycopg)

### Этап 3B: Документация

4) **Обновить документацию** по схеме БД (если нужно добавить миграции, индексы и т.п.)

---

## Definition of Done (готово)
1) [x] /start просит VK токен и vk_id.
2) [x] Токен и id проверяется через VK API.
3) [x] После проверки доступны "Настроить фильтры" и 4 вопроса.
4) [x] Главный экран: Предыдущий/Далее/Дополнительно.
5) [x] Избранное/ЧС работают (пока в памяти).
6) [x] Предыдущий/Далее работают через историю показов.
7) [x] Фото кандидатов отбираются через InsightFace (SCRFD + ArcFace) или по лайкам.
8) [x] Предзагрузка фото на 5 кандидатов вперёд.
9) [x] **Участник B**: Данные сохраняются в PostgreSQL (замена InMemoryUserRepo).
10) [x] **Участник B**: Таблицы создаются через SQL-скрипт.
11) [x] Документации достаточно для проверки.
