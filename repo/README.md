# VK Dating Telegram Bot

## 1. Описание проекта

Telegram-бот на Python, который подбирает людей для знакомств во ВКонтакте (vk.com) по критериям пользователя.

Возможности:
- Авторизация через VK токен с валидацией.
- Настройка фильтров поиска: город, пол, возраст.
- Просмотр карточек кандидатов с навигацией (Далее / Предыдущий).
- Отбор фотографий через распознавание лиц (InsightFace, SCRFD + ArcFace) **или** по количеству лайков.
- Избранное и чёрный список.
- Хранение данных в PostgreSQL (с fallback на InMemory при отсутствии `DATABASE_URL`).
- Предзагрузка фото для следующих кандидатов в фоне.

Стек: Python 3.11+, aiogram 3, SQLAlchemy 2 (async), PostgreSQL, Alembic, InsightFace/ONNXRuntime (опционально).

---

## 2. Архитектура

### 2.1 Слои приложения

```
Presentation (Telegram)     — UI, FSM-состояния, клавиатуры, обработчики
        ↓
Application (Services)      — бизнес-логика: авторизация, поиск, фото, навигация
        ↓
Infrastructure              — VK API, БД (PostgreSQL/InMemory), Vision (InsightFace)
        ↓
Core                        — конфигурация, логирование, исключения
```

- **Presentation** (`src/presentation/tg/`) — aiogram: bot.py, handlers.py, keyboards.py, states.py.
- **Application** (`src/application/services/`) — AuthService, DatingService, PhotoProcessingService.
- **Infrastructure** (`src/infrastructure/`) — VK client, PostgresUserRepo / InMemoryUserRepo, FaceDetector.
- **Core** (`src/core/`) — config.py, log_setup.py, exceptions.py.

### 2.2 Хранение данных

Бот автоматически выбирает хранилище при старте:
- Если `DATABASE_URL` задан в `.env` → **PostgreSQL** (через SQLAlchemy async + asyncpg).
- Если не задан → **InMemoryUserRepo** (данные теряются при перезапуске).

Обе реализации реализуют единый интерфейс `UserRepo` (Protocol, 18 async-методов).

Таблицы PostgreSQL: `users`, `profiles`, `photos`, `queue`, `favorites`, `blacklist`.
Миграции управляются через Alembic (`alembic/`).

Файлы фотографий (JPEG/PNG) хранятся на диске в `data/photos/<vk_user_id>/`, в БД — только пути и метаданные.

### 2.3 Архитектура кнопок

```
Старт
Настроить фильтры поиска
Главный экран
├── Предыдущий
├── Далее
└── Дополнительно
    ├── В избранное
    ├── В черный список
    ├── Показать избранное
    │   ├── [inline-кнопки VK ID] → просмотр анкеты
    │   ├── Удалить из избранного
    │   │   └── [inline-кнопки VK ID] → удаление
    │   └── Назад
    ├── Настроить фильтры поиска
    └── Назад
```

---

## 3. Инструкция по использованию

### 3.1 Переменные окружения (.env)

Создайте файл `.env` в корне проекта (по образцу ниже). Файл **не коммитится** в git.

| Переменная | Обязательна | Описание | Пример |
|---|---|---|---|
| `TG_TOKEN` | да | Токен Telegram бота (от @BotFather) | `123456:ABC-DEF...` |
| `VK_API_VERSION` | да | Версия VK API | `5.131` |
| `DATABASE_URL` | нет | URL подключения к PostgreSQL. Если не задан — данные хранятся в памяти | `postgresql+asyncpg://user:pass@localhost:5432/dbname` |
| `USE_INSIGHTFACE` | нет | Распознавание лиц: `true` или `false` (по умолчанию `true`) | `false` |
| `INSIGHTFACE_MODEL` | нет | Модель InsightFace (по умолчанию `buffalo_l`) | `buffalo_l` |
| `PHOTO_DIR` | нет | Путь для скачанных фото (по умолчанию `./data/photos`) | `./data/photos` |
| `PHOTO_BATCH_SIZE` | нет | Сколько фото скачивать для анализа (по умолчанию `10`) | `10` |
| `PHOTO_BUFFER_AHEAD` | нет | Сколько кандидатов предзагружать впереди курсора (по умолчанию `5`) | `5` |
| `CLEAN_DB_ON_START` | нет | Очистить все таблицы БД при старте: `true` или `false` (по умолчанию `false`) | `false` |

Пример `.env`:
```
VK_API_VERSION=5.131
TG_TOKEN=ваш_токен_телеграм_бота

DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/postgres

USE_INSIGHTFACE=false
INSIGHTFACE_MODEL=buffalo_l

PHOTO_DIR=./data/photos
PHOTO_BATCH_SIZE=10
PHOTO_BUFFER_AHEAD=5

CLEAN_DB_ON_START=false
```

### 3.2 Включение и отключение распознавания лиц

Переменная `USE_INSIGHTFACE` в `.env` переключает режим отбора фотографий:

| Значение | Поведение |
|---|---|
| `true` | Фото проходят через InsightFace: детекция лиц → фильтрация → проверка blur → эмбеддинги → группировка "один человек" → топ-3. Требуется установка дополнительных пакетов (см. раздел 4). |
| `false` | Фото отбираются по количеству лайков — берутся топ-3 самых залайканных. Дополнительные пакеты не нужны. |

Переключение: измените значение в `.env` и перезапустите бота.

### 3.3 Логика распознавания лиц (InsightFace)

При `USE_INSIGHTFACE=true` фотографии кандидата проходят через пайплайн:

**Шаг 1. Скачивание**
- Из VK загружаются фото профиля (API `photos.get`, альбом профиля).
- Фото сортируются по лайкам, скачиваются топ-N (настраивается `PHOTO_BATCH_SIZE`, по умолчанию 10).
- Скачивание параллельное через `asyncio.gather`.
- Файлы сохраняются в `data/photos/<vk_user_id>/`.

**Шаг 2. Детекция лиц (SCRFD)**
- Каждое фото проходит через детектор SCRFD (модель `buffalo_l`).
- Фильтрация: ровно 1 лицо на фото, уверенность детектора >= 0.5, размер лица >= 50px.
- Фото без лица, с несколькими лицами, мелким лицом или низкой уверенностью — отклоняются.
- Причина отклонения сохраняется: `no_face`, `multi_face`, `small_face`, `low_score`.

**Шаг 3. Оценка резкости (Variance of Laplacian)**
- Из фото вырезается кроп лица по bbox.
- Вычисляется variance of Laplacian — чем выше, тем резче.
- Если score < 50.0 — фото отклоняется как размытое (`blurry`).

**Шаг 4. Эмбеддинги и группировка (ArcFace)**
- Для каждого прошедшего фото извлекается 512-мерный эмбеддинг (ArcFace, L2-нормированный).
- Фото группируются по cosine similarity (порог >= 0.4 = "один и тот же человек").
- Если фото совпадает с существующей группой — добавляется в неё.
- Если не совпадает ни с одной — создаётся новая группа.

**Шаг 5. Выбор топ-3**
- Берётся самая большая группа (один человек с наибольшим числом фото).
- Внутри группы фото ранжируются по лайкам.
- Выбираются топ-3 (`status = selected`).
- Остальные фото получают `status = accepted` (прошли фильтры) или `rejected` (не прошли).

**Fallback:** если `USE_INSIGHTFACE=false`, InsightFace не установлен, или скачано менее 3 фото — берутся топ-3 по лайкам.

**Оптимизации:**
- InsightFace работает в `thread pool executor` — не блокирует event loop aiogram.
- При старте бота детектор прогревается (`warm_up_detector`), чтобы первый запрос не ждал загрузки модели (~280 МБ).
- Фоновая предзагрузка фото для следующих кандидатов (`PHOTO_BUFFER_AHEAD`).

### 3.4 Использование бота в Telegram (пошаговая инструкция)

#### Авторизация

1. Откройте бота в Telegram и нажмите `/start`.
2. Бот ответит: **"Чтобы начать нажмите Старт"**. Нажмите кнопку **Старт**.
3. Бот попросит: **"Шаг 1/2: Введите токен VK"**. Отправьте ваш VK access token текстом.
4. Бот попросит: **"Шаг 2/2: Введите VK_ID"**. Отправьте ваш числовой VK ID.
5. Бот проверит токен через VK API (`users.get`) и сверит владельца:
   - Успех: **"Токен валиден ✅ Данные авторизации записаны ✅"** → появляется кнопка **Настроить фильтры поиска**.
   - Ошибка: сообщение об ошибке VK, бот просит ввести токен заново.

#### Настройка фильтров

1. Нажмите **Настроить фильтры поиска**.
2. Бот задаёт 4 вопроса по очереди:
   - **"Шаг 1/4: Введите ваш город для поиска кандидатов"** — введите название города (например, Москва).
   - **"Шаг 2/4: Укажите пол для поиска (1=Жен, 2=Муж)"** — введите `1` или `2`.
   - **"Шаг 3/4: Введите возраст ОТ (число, не менее 18)"** — введите число от 18 до 100.
   - **"Шаг 4/4: Введите возраст ДО (число)"** — введите число (не меньше возраста ОТ).
3. Бот подтвердит: **"Фильтры настроены ✅"** с перечислением параметров.
4. Появляется главный экран с кнопками навигации.

#### Просмотр кандидатов

На главном экране доступны кнопки:

| Кнопка | Действие |
|---|---|
| **Далее** | Показать следующего кандидата. Если очередь пуста — бот выполнит поиск в VK по фильтрам. Если фото не готовы — появится "Ищу фото кандидата..." (сообщение удалится после загрузки). После показа запускается фоновая предзагрузка следующих кандидатов. |
| **Предыдущий** | Показать предыдущего кандидата из истории просмотров. Если вы в начале списка — "Вы в начале списка." |
| **Дополнительно** | Открыть меню дополнительных действий. |

Карточка кандидата содержит:
- Имя Фамилия
- Ссылку на профиль VK (`vk.com/domain` или `vk.com/idXXXXX`)
- До 3 фотографий (отобранных через InsightFace или по лайкам)

Кандидаты без фото автоматически пропускаются (до 10 подряд).

#### Дополнительные действия

В меню **Дополнительно**:

| Кнопка | Действие |
|---|---|
| **В избранное** | Добавить текущего кандидата в избранное. |
| **В черный список** | Добавить текущего кандидата в чёрный список. Кандидат удаляется из очереди и больше не показывается. Курсор корректируется автоматически. |
| **Показать избранное** | Показать список избранных (inline-кнопки с VK ID). Нажатие на VK ID → просмотр анкеты с фото. |
| **Настроить фильтры поиска** | Перенастроить фильтры (очередь кандидатов сбрасывается). |
| **Назад** | Вернуться на главный экран. |

В меню **Показать избранное**:

| Кнопка | Действие |
|---|---|
| **Удалить из избранного** | Переход в режим удаления: inline-кнопки с VK ID, нажатие удаляет из избранного. |
| **Назад** | Вернуться в меню Дополнительно. |

---

## 4. Установка и запуск

### 4.1 Базовая установка (без распознавания лиц)

```bash
# Создать виртуальное окружение
python -m venv venv

# Активировать (Windows):
venv\Scripts\activate
# Активировать (Linux/macOS):
source venv/bin/activate

# Установить зависимости
pip install -r requirements.txt
```

Создайте `.env` файл (см. раздел 3.1) с минимальным набором:
```
TG_TOKEN=ваш_токен_телеграм_бота
VK_API_VERSION=5.131
USE_INSIGHTFACE=false
```

Если используете PostgreSQL — добавьте `DATABASE_URL` и примените миграции:
```bash
alembic upgrade head
```

Запуск:
```bash
python -m src.main
```

### 4.2 Установка с распознаванием лиц (InsightFace)

#### Шаг 1. Установить зависимости

```bash
pip install numpy opencv-python onnxruntime
```

#### Шаг 2. Установить InsightFace

**Linux / macOS (или Windows с Visual Studio Build Tools):**
```bash
pip install insightface
```

**Windows без Visual Studio Build Tools** (обходной путь):

InsightFace 0.7.3 требует компиляции C-расширения `mesh_core_cython`. Без компилятора выполните:

```bash
# 1) Установить wheel (нужен для сборки)
pip install wheel

# 2) Скачать исходники
mkdir tmp_pkg
pip download insightface==0.7.3 --no-binary insightface --no-deps -d ./tmp_pkg

# 3) Распаковать архив
cd tmp_pkg
tar xzf insightface-0.7.3.tar.gz

# 4) В файле tmp_pkg/insightface-0.7.3/setup.py:
#    - Удалить строки с import Cython (from Cython.Distutils, from Cython.Build)
#    - Удалить строки с import Extension (from distutils.core import Extension)
#    - Заменить extensions = [...] на extensions = []
#    - Заменить ext_modules=cythonize(extensions) на ext_modules=[]
#    - Удалить строки headers=[...], ext_modules=ext_modules, include_dirs=numpy.get_include()

# 5) Установить из изменённого каталога
cd ..
pip install ./tmp_pkg/insightface-0.7.3/ --no-deps --no-build-isolation

# 6) Пропатчить файл venv/.../insightface/thirdparty/face3d/mesh/__init__.py:
#    Заменить:
#      from .cython import mesh_core_cython
#    На:
#      try:
#          from .cython import mesh_core_cython
#      except ImportError:
#          mesh_core_cython = None

# 7) Пропатчить файл venv/.../insightface/app/__init__.py:
#    Заменить:
#      from .mask_renderer import *
#    На:
#      try:
#          from .mask_renderer import *
#      except ImportError:
#          pass

# 8) Установить runtime-зависимости insightface
pip install onnx tqdm requests matplotlib Pillow scipy scikit-learn scikit-image easydict albumentations prettytable
```

Модуль `mesh_core_cython` используется только для 3D-рендеринга масок — он не нужен для основной задачи (детекция + эмбеддинги).

#### Шаг 3. Настроить .env

```
USE_INSIGHTFACE=true
INSIGHTFACE_MODEL=buffalo_l
```

#### Шаг 4. Запуск

```bash
python -m src.main
```

При первом запуске модель `buffalo_l` (~280 МБ) скачивается автоматически в `data/models/`.
В логах появится: `FaceDetector инициализирован (buffalo_l, CPU)` и `FaceDetector прогрет и готов к работе`.

---

## 5. Требования

- Python 3.11+
- Telegram Bot Token (от @BotFather)
- VK user token + VK ID (пользователь вводит в чат бота)

Опционально:
- PostgreSQL (для постоянного хранения данных)
- InsightFace + ONNXRuntime + OpenCV + NumPy (для распознавания лиц)
