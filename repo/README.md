# VK Dating Telegram Bot (локальный проект)

## 1. Описание
Telegram-бот на Python, который подбирает людей для знакомств во ВКонтакте (vk.com) по критериям пользователя.
Проект запускается и работает только локально.

Ключевые особенности:
- При старте бот просит у пользователя VK токен: сообщение "Введите токен vk".
- Бот тестирует соединение с VK (валидирует токен).
- После успешной проверки появляется кнопка "Настроить фильтры поиска".
- Фильтры настраиваются через 4 вопроса:
  1) Укажите город для поиска
  2) Укажите пол для поиска кандидатов
  3) Укажите интересующий начальный возраст кандидатов
  4) Укажите интересующий максимальный возраст кандидатов
- Фотографии кандидатов отбираются с помощью распознавания лиц (InsightFace / ONNXRuntime, CPU):
  - Детектор SCRFD — поиск лиц, фильтрация (ровно одно лицо, без размытия).
  - Эмбеддинги ArcFace (512-d) — проверка, что на топ-3 фото один и тот же человек.
  - Файлы (JPEG/PNG) хранятся на диске (`data/photos/`), метаданные и эмбеддинги — в PostgreSQL.
- После настройки фильтров доступен главный экран с навигацией по кандидатам и дополнительными действиями:
  - Предыдущий
  - Далее
  - Дополнительно → В избранное / В чёрный список / Показать избранное → Удалить из избранного / Настроить фильтры
- Кнопок лайка нет.

---

## 2. Архитектура кнопок (по ТЗ пользователя)
|- Старт  
|- Настроить фильтры  
|- Кнопки главного экрана  
   |- Предыдущий  
   |- Далее  
   |- Дополнительно  
      |- В избранное  
      |- В черный список  
      |- Назад
      |- Показать избранное  
         |- Удалить из избранного  
         |- Назад
      |- Настроить фильтры  

Примечания:
- “Старт” — это стартовая точка диалога (/start) и стартовая кнопка/экран.
- “Настроить фильтры” открывает режим опроса (4 шага).
- “Дополнительно” — вложенное меню.

---

## 3. Основные сценарии работы

### 3.1 Старт и ввод токена
1) Пользователь нажимает “Старт” или вводит `/start`.
2) Бот отвечает: “Введите токен vk”.
3) Пользователь отправляет токен текстом.
4) Затем бот запрашивает VK_APP_ID → “Введите ваш vk id” и пользователь отправляет ID
5) Бот тестирует соединение с VK:
   - если токен валиден → “Токен принят. Соединение с VK успешно.” и показывает кнопку “Настроить фильтры поиска”.
   - если токен невалиден → “Ошибка токена. Повторите ввод.” и снова ждёт токен.

### 3.2 Настройка фильтров
1) Пользователь нажимает “Настроить фильтры поиска”.
2) Бот задаёт вопросы по очереди:
   1) “Укажите город для поиска”
   2) “Укажите пол для поиска кандидатов”
   3) “Укажите интересующий начальный возраст кандидатов”
   4) “Укажите интересующий максимальный возраст кандидатов”
3) После ввода всех 4 параметров:
   - бот сохраняет фильтры в БД,
   - показывает главный экран (кнопки навигации “Предыдущий/Далее/Дополнительно”).

### 3.3 Просмотр кандидатов
- "Далее" → показать следующего кандидата.
- "Предыдущий" → показать предыдущего кандидата (по локальной истории показов).
Карточка кандидата содержит:
- Имя Фамилия
- Ссылка на профиль VK
- 3 лучшие фотографии (отобраны через InsightFace: одно лицо, без размытия, один человек)

### 3.5 Обработка фотографий (фоновый процесс)
Фотографии обрабатываются в фоне малыми пачками (по 5 кандидатов), опережая курсор пользователя:
1) Скачивание фото кандидата с VK (photos.get, сортировка по лайкам).
2) Детекция лиц (SCRFD) — отсев фото без лица или с несколькими лицами.
3) Оценка резкости (variance of Laplacian) — отсев размытых фото.
4) Вычисление эмбеддингов (ArcFace 512-d) — проверка, что на фото один и тот же человек.
5) Выбор топ-3 фото (status = selected) для показа в карточке.
6) Метаданные и эмбеддинги сохраняются в таблице `vk_photos`, файлы — в `data/photos/`.

### 3.4 Дополнительные действия
- “В избранное” → сохраняет текущего кандидата в избранное (БД).
- “В чёрный список” → добавляет текущего кандидата в чёрный список (БД), чтобы больше не показывался.
- “Показать избранное” → выводит список избранных; для каждого доступно “Удалить из избранного”.

---

## 4. Хранение состояния (локально)
Используется PostgreSQL (локально):
- `tg_users` — vk_token, vk_id, фильтры поиска, курсор истории,
- `vk_profiles` — данные кандидатов (имя, фамилия, ссылка, статус обработки),
- `vk_photos` — метаданные фото, результаты детекции лиц, эмбеддинги ArcFace,
- `search_queue` — очередь кандидатов из users.search (per user, с позицией),
- `seen_profiles` — показанные кандидаты (исключение повторов),
- `view_history` — упорядоченная история просмотров (для "Предыдущий/Далее"),
- `favorite_profiles` — избранное,
- `blacklist_profiles` — чёрный список.

Файлы фотографий (JPEG/PNG) хранятся на диске в `data/photos/`, в БД — только пути и метаданные.

---

## 5. Ограничение VK users.search (1000 результатов) и обход
VK ограничивает выдачу поиска 1000 анкет.
Чтобы обходить ограничение используется стратегия сегментации:
- дробим возрастной диапазон на интервалы,
- перебираем интервалы, пока не найдём подходящих кандидатов, которых нет в seen/blacklist,
- при переполнении сегмента — дробим интервал ещё.

Реализация: `src/application/strategies/search_pagination.py`

---

## 6. Требования
- Python 3.11+
- PostgreSQL локально (установленный или Docker — опционально)
- Telegram Bot Token (в .env)
- VK user token + vk id (пользователь вводит в чат бота)
- InsightFace + ONNXRuntime (CPU) — модель buffalo_l (SCRFD + ArcFace)
- OpenCV (cv2) — скачивание и предобработка фото, оценка резкости

---

## 7. Установка (локально)
1) Виртуальное окружение и зависимости:
   ```bash
   python -m venv .venv
   # Windows:
   .venv\Scripts\activate
   # Linux/macOS:
   source .venv/bin/activate

   pip install -r requirements.txt
