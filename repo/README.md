# VK Dating Telegram Bot (локальный проект)

## 1. Описание
Telegram-бот на Python, который подбирает людей для знакомств во ВКонтакте (vk.com) по критериям пользователя.
Проект запускается и работает только локально.

Ключевые особенности:
- При старте бот просит у пользователя VK токен: сообщение “Введите токен vk”.
- Бот тестирует соединение с VK (валидирует токен).
- После успешной проверки появляется кнопка “Настроить фильтры поиска”.
- Фильтры настраиваются через 4 вопроса:
  1) Укажите город для поиска
  2) Укажите пол для поиска кандидатов
  3) Укажите интересующий начальный возраст кандидатов
  4) Укажите интересующий максимальный возраст кандидатов
- После настройки фильтров доступен главный экран с навигацией по кандидатам и дополнительными действиями:
  - Предыдущий
  - Далее
  - Дополнительно → Добавить в избранное / В чёрный список / Показать избранное → Удалить из избранного / Настроить фильты
- Кнопок лайка нет.

---

## 2. Архитектура кнопок (по ТЗ пользователя)
|- Старт
|- Настроить фильтры
|- Кнопки главного экрана
   |- Предыдущий
   |- Далее
   |- Дополнительно
      |- Добавить в избранное
      |- В черный список
      |- Показать избранное
         |- Удалить из избранного
      |- Настроить фильтры    

Примечания:
- “Старт” — это стартовая точка диалога (/start) и стартовая кнопка/экран.
- “Настроить фильтры” открывает режим опроса (4 шага).
- “Дополнительно” — вложенное меню.

---

## 3. Основные сценарии работы

### 3.1 Старт и ввод токена
1) Пользователь нажимает “Старт” или вводит `/start`.
2) Бот отвечает: “Введите токен vk”.
3) Пользователь отправляет токен текстом.
4) Затем бот запрашивает VK_APP_ID → “Введите ваш vk id” и пользователь отправляет ID
5) Бот тестирует соединение с VK:
   - если токен валиден → “Токен принят. Соединение с VK успешно.” и показывает кнопку “Настроить фильтры поиска”.
   - если токен невалиден → “Ошибка токена. Повторите ввод.” и снова ждёт токен.

### 3.2 Настройка фильтров
1) Пользователь нажимает “Настроить фильтры поиска”.
2) Бот задаёт вопросы по очереди:
   1) “Укажите город для поиска”
   2) “Укажите пол для поиска кандидатов”
   3) “Укажите интересующий начальный возраст кандидатов”
   4) “Укажите интересующий максимальный возраст кандидатов”
3) После ввода всех 4 параметров:
   - бот сохраняет фильтры в БД,
   - показывает главный экран (кнопки навигации “Предыдущий/Далее/Дополнительно”).

### 3.3 Просмотр кандидатов
- “Далее” → показать следующего кандидата.
- “Предыдущий” → показать предыдущего кандидата (по локальной истории показов).
Карточка кандидата содержит:
- Имя Фамилия
- Ссылка на профиль VK
- 3 фотографии (attachments)

### 3.4 Дополнительные действия
- “Добавить в избранное” → сохраняет текущего кандидата в избранное (БД).
- “В чёрный список” → добавляет текущего кандидата в чёрный список (БД), чтобы больше не показывался.
- “Показать избранное” → выводит список избранных; для каждого доступно “Удалить из избранного”.

---

## 4. Хранение состояния (локально)
Используется PostgreSQL (локально):
- хранение vk_token и vk_id пользователя (связка с tg_user),
- фильтры поиска (город, пол, возраст от/до),
- история просмотренных кандидатов (для “Предыдущий/Далее” и исключения повторов),
- избранное,
- чёрный список.

---

## 5. Ограничение VK users.search (1000 результатов) и обход
VK ограничивает выдачу поиска 1000 анкет.
Чтобы обходить ограничение используется стратегия сегментации:
- дробим возрастной диапазон на интервалы,
- перебираем интервалы, пока не найдём подходящих кандидатов, которых нет в seen/blacklist,
- при переполнении сегмента — дробим интервал ещё.

Реализация: `src/application/strategies/search_pagination.py`

---

## 6. Требования
- Python 3.11+
- PostgreSQL локально (установленный или Docker — опционально)
- Telegram Bot Token (в .env)
- VK user token + vk id (пользователь вводит в чат бота)

---

## 7. Установка (локально)
1) Виртуальное окружение и зависимости:
   ```bash
   python -m venv .venv
   # Windows:
   .venv\Scripts\activate
   # Linux/macOS:
   source .venv/bin/activate

   pip install -r requirements.txt
